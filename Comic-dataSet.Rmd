---
title: "COMICDATASET"
author: "Grupo 1 - DataScience"
date: "2/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#limpiar el enviroment
#rm(list = ls())

#librerias base
library(tidyverse)
library (caTools)
library(readr)
library(lubridate)
library(eeptools)
library(ggplot2)
library(ggpubr)
library(plotly) # Interactive visualizations
library(ggthemes) # Visualization themes
library(viridis) # Color scales
library(corrplot) # Correlation visualizations
library(gridExtra) # Grids for visualizations
library(magrittr) # needs to be run every time you start R and want to use %>%
library(dplyr)    # alternatively, this also loads %>%
library(randomForest) # Classification algorithm
library(VIM)
theme_set(theme_pubr())
```
## DEFINICION DE FUNCIONES AUXILIARES

Creamos dos funciones para uso posterior en el dataset, una para la matrix de correlacion y otra para el calculo de la decada de aparicion de los personajes.

```{r Funciones iniciales}

################################################################
#FUNCION PARA CALCULO DE DECADA
floor_decade    = function(value){ return(value - value %% 10) }
mi_moda<-function(var){
  frec.var<-table(var)
  valor<-which(frec.var==max(frec.var)) # Elementos con el valor máximo
  names(valor)
}
################################################################

```
## Lectura Inicial DEL DATASET DE DC

Cargamos los dataset en dos dataframes DC 

```{r DC comics}

#################################################################
###########INICIO LECTURA Y DETECCION DE DATOS VACIOS############
#################################################################

getwd()
dir()
dcoriginal <- read.csv("dc-wikia-data.csv")
dc<-dcoriginal
str(dc)
summary(dc)

#TRATAMIENTO DE COLUMNAS TIPO STRING
dc$name <- as.character(dc$name)
dc$urlslug <- as.character(dc$urlslug)
dc$FIRST.APPEARANCE <- as.character(dc$FIRST.APPEARANCE)


summary(dc)
str(dc)

length(which(is.na(dc$page_id)))
length(which(dc$page_id==''))

length(which(is.na(dc$name)))
length(which(dc$name==''))

length(which(is.na(dc$urlslug)))
length(which(dc$urlslug==''))

length(which(is.na(dc$ID)))
length(which(dc$ID==''))

length(which(is.na(dc$ALIGN)))
length(which(dc$ALIGN==''))

length(which(is.na(dc$EYE)))
length(which(dc$EYE==''))

length(which(is.na(dc$HAIR)))
length(which(dc$HAIR==''))

length(which(is.na(dc$SEX)))
length(which(dc$SEX==''))

length(which(is.na(dc$GSM)))
length(which(dc$GSM==''))

length(which(is.na(dc$ALIVE)))
length(which(dc$ALIVE==''))

length(which(is.na(dc$APPEARANCES)))
length(which(dc$APPEARANCES==''))

length(which(is.na(dc$FIRST.APPEARANCE)))
length(which(dc$FIRST.APPEARANCE==''))

length(which(is.na(dc$YEAR)))
length(which(dc$YEAR==''))

#################################################################
#############FIN LECTURA Y DETECCION DE DATOS VACIOS#############
#################################################################


#################################################################
#############INICIO TRATAMIENTO DE VALORES VACIOS################
#################################################################
summary(dc)
str(dc)

#PARA ID FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
dc$ID <- as.character(dc$ID) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
dc$ID[dc$ID==''] <- 'NOT SPECIFIED' 
dc$ID <- factor (dc$ID) #RECONVERSION A FACTOR

#PARA ALIGN FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
dc$ALIGN <- as.character(dc$ALIGN) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
dc$ALIGN[dc$ALIGN==''] <- 'NOT SPECIFIED' 
dc$ALIGN <- factor (dc$ALIGN) #RECONVERSION A FACTOR

#PARA EYE FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
dc$EYE <- as.character(dc$EYE) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
dc$EYE[dc$EYE==''] <- 'NOT SPECIFIED' 
dc$EYE <- factor (dc$EYE) #RECONVERSION A FACTOR

#PARA EYE FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
dc$HAIR <- as.character(dc$HAIR) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
dc$HAIR[dc$HAIR==''] <- 'NOT SPECIFIED' 
dc$HAIR <- factor (dc$HAIR) #RECONVERSION A FACTOR

#PARA SEX FALTANTES: LUEGO DE UNA ASIGNACION MANUAL SEGUN CORRESPONDA CON INFORMACION DE INTERNET
which(dc$SEX=='')
dc$SEX <- as.character(dc$SEX)
dc[243, 'SEX'] <- 'Male Characters'
dc[344, 'SEX'] <- 'Female Characters'
dc[353, 'SEX'] <- 'Male Characters'
dc[515, 'SEX'] <- 'Male Characters'
dc[629, 'SEX'] <- 'Male Characters'
dc[684, 'SEX'] <- 'Female Characters'
dc[753, 'SEX'] <- 'Male Characters'
dc[836, 'SEX'] <- 'Male Characters'
dc[1075, 'SEX'] <- 'Male Characters'
dc[1156, 'SEX'] <- 'Male Characters'
dc[1164, 'SEX'] <- 'Male Characters'
dc[1236, 'SEX'] <- 'Male Characters'
dc[1271, 'SEX'] <- 'Male Characters'
dc[1434, 'SEX'] <- 'Male Characters'
dc[1470, 'SEX'] <- 'Male Characters'
dc[1472, 'SEX'] <- 'Male Characters'
dc[1615, 'SEX'] <- 'Female Characters'
dc[1617, 'SEX'] <- 'Male Characters'
dc[1618, 'SEX'] <- 'Male Characters'
dc[1769, 'SEX'] <- 'Male Characters'
dc[1795, 'SEX'] <- 'Male Characters'
dc[1811, 'SEX'] <- 'Male Characters'
dc[1819, 'SEX'] <- 'Male Characters'
dc[1889, 'SEX'] <- 'Male Characters'
dc[2072, 'SEX'] <- 'Male Characters'
dc[2101, 'SEX'] <- 'Male Characters'
dc[2154, 'SEX'] <- 'Female Characters'
dc[2158, 'SEX'] <- 'Male Characters'
dc[2195, 'SEX'] <- 'Male Characters'
dc[2662, 'SEX'] <- 'Male Characters'
dc[2667, 'SEX'] <- 'Male Characters'
dc[2670, 'SEX'] <- 'Male Characters'
dc[2840, 'SEX'] <- 'Male Characters'
dc[3083, 'SEX'] <- 'Male Characters'
dc[3096, 'SEX'] <- 'Male Characters'
dc[3131, 'SEX'] <- 'Male Characters'
dc[3171, 'SEX'] <- 'Male Characters'
dc[3194, 'SEX'] <- 'Male Characters'
dc[3355, 'SEX'] <- 'Male Characters'

#CONTRASTAMOS LA PREDOMINACION MASCULINA, POR LO QUE SE OPTA POR REEMPLAZAR EL VALOR POR LA MODA.
mi_moda(dc$SEX)
dc$SEX[dc$SEX==''] <- 'Male Characters' 

#DETECTAMOS "TRANSGENDER" Y "GENDERLESS" COMO SEXO
#PROCEDEMOS CON LA DEPURACION DE TRANSGENDER Y GENDERLESS COMO SEXO, Y ASIGNACION DEL GENERO A LA VARIABLE CORRECTA "GSM".
which(dc$SEX=='Transgender Characters')
which(dc$SEX=='Genderless Characters')

dc[3878, 'SEX'] <- 'Female Characters'
dc[797, 'SEX'] <- 'Male Characters'
dc[906, 'SEX'] <- 'Male Characters'
dc[907, 'SEX'] <- 'Male Characters'
dc[921, 'SEX'] <- 'Male Characters'
dc[1123, 'SEX'] <- 'Male Characters'
dc[1295, 'SEX'] <- 'Male Characters'
dc[1871, 'SEX'] <- 'Male Characters'
dc[2146, 'SEX'] <- 'Male Characters'
dc[2255, 'SEX'] <- 'Male Characters'
dc[2678, 'SEX'] <- 'Male Characters'
dc[2801, 'SEX'] <- 'Male Characters'
dc[3608, 'SEX'] <- 'Male Characters'
dc[3729, 'SEX'] <- 'Male Characters'
dc[4092, 'SEX'] <- 'Male Characters'
dc[5014, 'SEX'] <- 'Male Characters'
dc[5080, 'SEX'] <- 'Male Characters'
dc[5336, 'SEX'] <- 'Male Characters'
dc[5844, 'SEX'] <- 'Male Characters'
dc[5857, 'SEX'] <- 'Male Characters'
dc[6854, 'SEX'] <- 'Male Characters'

dc$GSM <- as.character (dc$GSM)
dc[797, 'GSM'] <- 'Agender Characters'
dc[906, 'GSM'] <- 'Agender Characters'
dc[907, 'GSM'] <- 'Agender Characters'
dc[921, 'GSM'] <- 'Agender Characters'
dc[1123, 'GSM'] <- 'Agender Characters'
dc[1295, 'GSM'] <- 'Agender Characters'
dc[1871, 'GSM'] <- 'Agender Characters'
dc[2146, 'GSM'] <- 'Agender Characters'
dc[2255, 'GSM'] <- 'Agender Characters'
dc[2678, 'GSM'] <- 'Agender Characters'
dc[2801, 'GSM'] <- 'Agender Characters'
dc[3608, 'GSM'] <- 'Agender Characters'
dc[3729, 'GSM'] <- 'Agender Characters'
dc[4092, 'GSM'] <- 'Agender Characters'
dc[5014, 'GSM'] <- 'Agender Characters'
dc[5080, 'GSM'] <- 'Agender Characters'
dc[5336, 'GSM'] <- 'Agender Characters'
dc[5844, 'GSM'] <-'Agender Characters'
dc[5857, 'GSM'] <- 'Agender Characters'
dc[6854, 'GSM'] <- 'Agender Characters'
dc[3878, 'GSM'] <- 'Agender Characters'
dc[1295, 'GSM'] <- 'Genderfluid Characters'
dc$SEX <- factor (dc$SEX) #RECONVERSION A FACTOR
dc$GSM <- factor (dc$GSM) #RECONVERSION A FACTOR


#PARA GSM FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
dc$GSM <- as.character(dc$GSM) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
dc$GSM[dc$GSM==''] <- 'NOT SPECIFIED' 
dc$GSM <- factor (dc$GSM) #RECONVERSION A FACTOR


#PARA ALIVE FALTANTES: LOS ASIGNAREMOS SEGUN CORRESPONDA CON INFORMACION DE INTERNET
which(dc$ALIVE=='')
dc$ALIVE <- as.character(dc$ALIVE) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
dc[2727, 'ALIVE'] <- 'Living Characters'
dc[3251, 'ALIVE'] <- 'Living Characters'
dc[6855, 'ALIVE'] <- 'Living Characters'
dc$ALIVE <- factor (dc$ALIVE) #RECONVERSION A FACTOR


#CORRECCION DE CARACTERISTICAS FISICAS: EYE, HAIR
levels(dc$EYE)
which(dc$EYE=='Auburn Hair')
view(which(dc$EYE=='Auburn Hair'))
dc$HAIR<-as.character(dc$HAIR)
dc$EYE<-as.character(dc$EYE)
dc$HAIR[dc$EYE=='Auburn Hair'] <- 'Auburn Hair' 
dc$EYE[dc$EYE=='Auburn Hair'] <- 'NOT SPECIFIED'
dc$HAIR<-factor(dc$HAIR)
dc$EYE<-factor(dc$EYE)
view(dc)


#PARA APPEARANCES FALTANTES: LOS ASIGNAREMOS SEGUN EL PROMEDIO DE LA VARIABLE
dc$APPEARANCES[is.na(dc$APPEARANCES)]<-ceiling(mean(dc$APPEARANCES,na.rm=TRUE))

#PARA FIRST.APPEARANCE FALTANTES: ELIMINACION DE OBSERVACIONES
dc<-subset(dc, !is.na(dc$FIRST.APPEARANCE) | dc$FIRST.APPEARANCE=='')

#PARA YEAR: ELIMINACION DE OBSERVACIONES
dc<-subset(dc, !is.na(dc$YEAR))

which(is.na(dc))


#################################################################
################FIN TRATAMIENTO DE VALORES VACIOS################
#################################################################


#################################################################
################INICIO CREACION DE VARIABLES#####################
#################################################################

#AGREGA COLUMNA CON EL PARSEO DE FECHA DE APARICION DE STRING A DATE
dc$FECHA.APARICION<-parse_date_time(dc$FIRST.APPEARANCE, orders = c("Yb"))
dc$FECHA.APARICION <- as.Date(dc$FECHA.APARICION)

#CORRECCION DE ERRORES DEL PARSEO DE FECHA
which(is.na(dc$FECHA.APARICION))
#SE REVISA QUE CONTIENEN FECHAS INCOMPLETAS, SE PROCEDE A ELIMINAR LOS REGISTROS CON FECHAS ERRONEAS.
dc<-subset(dc, !is.na(dc$FECHA.APARICION))
#ELIMINACION DE COLUMNA DE FECHA ORIGINAL SIN PARSEAR
dc[ ,c('FIRST.APPEARANCE')] <- list(NULL)

#AGREGA COLUMNA CON LOS AñOS DESDE LA APARICION DEL PERSONAJE
dc$TIEMPO.APARICION<-floor(age_calc(dc$FECHA.APARICION, enddate = Sys.Date(), units = "years", precise = TRUE))

#AGREGA COLUMNA CON EL PARSEO MES DE APARICION
dc$MES.APARICION <- ymd(dc$FECHA.APARICION) %>% 
   lubridate::month(label = TRUE, abbr = FALSE)

#AGREGA COLUMNA CON EL PARSEO TRIMESTRE DE APARICION
dc$TRIMESTRE.APARICION<- ymd(dc$FECHA.APARICION) %>%
   lubridate::quarter()  # Grab quarter.

#AGREGA COLUMNA CON LA DECADA DE APARICION
dc$DECADA.APARICION <- floor_decade(dc$YEAR)

summary(dc)
which(is.na(dc))


#################################################################
################FIN CREACION DE VARIABLES########################
#################################################################

#################################################################
#############INICIO CORRELACION DE VARIABLES#####################
#################################################################


dccorrelation<-dc
dccorrelation[ ,c('name', 'urlslug')] <- list(NULL)
summary(dccorrelation)

dccorrelation$ID<-as.numeric(dccorrelation$ID)
dccorrelation$ALIGN<-as.numeric(dccorrelation$HAIR)
dccorrelation$HAIR<-as.numeric(dccorrelation$EYE)
dccorrelation$EYE<-as.numeric(dccorrelation$ID)
dccorrelation$SEX<-as.numeric(dccorrelation$SEX)
dccorrelation$GSM<-as.numeric(dccorrelation$GSM)
dccorrelation$ALIVE<-as.numeric(dccorrelation$ALIVE)
dccorrelation$FECHA.APARICION<-as.numeric((dccorrelation$FECHA.APARICION))
dccorrelation$YEAR<-as.numeric(dccorrelation$YEAR)
dccorrelation$MES.APARICION<-as.numeric(dccorrelation$MES.APARICION)
dccorrelation$TRIMESTRE.APARICION<-as.numeric(dccorrelation$TRIMESTRE.APARICION)

cor(dccorrelation)

#################################################################
################FIN CORRELACION DE VARIABLES#####################
#################################################################

```

## Lectura Inicial DEL DATASET DE MARVEL


CARGA DEL DATASET DE MARVEL COMICS 

```{r MARVEL comics}


#################################################################
###########INICIO LECTURA Y DETECCION DE DATOS VACIOS############
#################################################################
marveloriginal <- read.csv("marvel-wikia-data.csv")
str(marveloriginal)
summary(marveloriginal)
#HOMOGENIZACION DE NOMBRES DE VARIABLES
names(marveloriginal) <- names(dcoriginal) 


#TRATAMIENTO DE COLUMNAS TIPO STRING
marvel<-marveloriginal
marvel$name <- as.character(marvel$name)
marvel$urlslug <- as.character(marvel$urlslug)
marvel$FIRST.APPEARANCE <- as.character(marvel$FIRST.APPEARANCE)

summary(marvel)
str(marvel)

length(which(is.na(marvel$page_id)))
length(which(marvel$page_id==''))

length(which(is.na(marvel$name)))
length(which(marvel$name==''))

length(which(is.na(marvel$urlslug)))
length(which(marvel$urlslug==''))

length(which(is.na(marvel$ID)))
length(which(marvel$ID==''))

length(which(is.na(marvel$ALIGN)))
length(which(marvel$ALIGN==''))

length(which(is.na(marvel$EYE)))
length(which(marvel$EYE==''))

length(which(is.na(marvel$HAIR)))
length(which(marvel$HAIR==''))

length(which(is.na(marvel$SEX)))
length(which(marvel$SEX==''))

length(which(is.na(marvel$GSM)))
length(which(marvel$GSM==''))

length(which(is.na(marvel$ALIVE)))
length(which(marvel$ALIVE==''))

length(which(is.na(marvel$APPEARANCES)))
length(which(marvel$APPEARANCES==''))

length(which(is.na(marvel$FIRST.APPEARANCE)))
length(which(marvel$FIRST.APPEARANCE==''))

length(which(is.na(marvel$YEAR)))
length(which(marvel$YEAR==''))


#################################################################
#############FIN LECTURA Y DETECCION DE DATOS VACIOS#############
#################################################################


#################################################################
#############INICIO TRATAMIENTO DE VALORES VACIOS################
#################################################################
summary(marvel)
str(marvel)

#PARA ID FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
marvel$ID <- as.character(marvel$ID) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
marvel$ID[marvel$ID==''] <- 'NOT SPECIFIED' 
marvel$ID <- factor (marvel$ID) #RECONVERSION A FACTOR

#PARA ALIGN FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
marvel$ALIGN <- as.character(marvel$ALIGN) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
marvel$ALIGN[marvel$ALIGN==''] <- 'NOT SPECIFIED' 
marvel$ALIGN <- factor (marvel$ALIGN) #RECONVERSION A FACTOR

#PARA EYE FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
marvel$EYE <- as.character(marvel$EYE) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
marvel$EYE[marvel$EYE==''] <- 'NOT SPECIFIED' 
marvel$EYE <- factor (marvel$EYE) #RECONVERSION A FACTOR

#PARA EYE FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
marvel$HAIR <- as.character(marvel$HAIR) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
marvel$HAIR[marvel$HAIR==''] <- 'NOT SPECIFIED' 
marvel$HAIR <- factor (marvel$HAIR) #RECONVERSION A FACTOR

#PARA SEX FALTANTES: POR LO QUE SE OPTA POR REEMPLAZAR EL VALOR POR LA MODA.
mi_moda(marvel$SEX)
marvel$SEX[marvel$SEX==''] <- 'Male Characters' 

#DETECTAMOS "AGENDER" Y "GENDERFLUID" COMO SEXO
#PROCEDEMOS CON LA DEPURACION DE TRANSGENDER Y GENDERLESS COMO SEXO, Y ASIGNACION DEL GENERO A LA VARIABLE CORRECTA "GSM".
length(which(marvel$SEX=='Agender Characters'))
length(which(marvel$SEX=='Genderfluid Characters'))
marvel$GSM <- as.character (marvel$GSM)
marvel$GSM[marvel$SEX=='Agender Characters'] <- 'Agender Characters' 
marvel$GSM[marvel$SEX=='Genderfluid Characters'] <- 'Genderfluid Characters' 
marvel$SEX[marvel$SEX=='Agender Characters'] <- 'Male Characters' 
marvel$SEX[marvel$SEX=='Genderfluid Characters'] <- 'Male Characters' 
marvel$SEX <- factor (marvel$SEX) #RECONVERSION A FACTOR
marvel$GSM <- factor (marvel$GSM) #RECONVERSION A FACTOR


#PARA GSM FALTANTES: CREAMOS CATEGORIA "NOT SPECIFIED"
marvel$GSM <- as.character(marvel$GSM) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
marvel$GSM[marvel$GSM==''] <- 'NOT SPECIFIED' 
marvel$GSM <- factor (marvel$GSM) #RECONVERSION A FACTOR


#PARA ALIVE FALTANTES: LOS ASIGNAREMOS SEGUN CORRESPONDA CON INFORMACION DE INTERNET
which(marvel$ALIVE=='')
marvel$ALIVE <- as.character(marvel$ALIVE) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
marvel$ALIVE[marvel$ALIVE=='']<-'Living Characters'
marvel$ALIVE <- factor (marvel$ALIVE) #RECONVERSION A FACTOR

#PARA APPEARANCES FALTANTES: LOS ASIGNAREMOS SEGUN EL PROMEDIO DE LA VARIABLE
marvel$APPEARANCES[is.na(marvel$APPEARANCES)]<-ceiling(mean(marvel$APPEARANCES,na.rm=TRUE))


#PARA FIRST.APPEARANCE FALTANTES: ELIMINACION DE OBSERVACIONES
marvel<-subset(marvel, !is.na(marvel$FIRST.APPEARANCE) | marvel$FIRST.APPEARANCE=='')

#PARA YEAR: ELIMINACION DE OBSERVACIONES
marvel<-subset(marvel, !is.na(marvel$YEAR))

which(is.na(marvel))


#################################################################
################FIN TRATAMIENTO DE VALORES VACIOS################
#################################################################


#################################################################
################INICIO CREACION DE VARIABLES#####################
#################################################################

#AGREGA COLUMNA CON EL PARSEO DE FECHA DE APARICION DE STRING A DATE
marvel$FECHA.APARICION<-parse_date_time2(marvel$FIRST.APPEARANCE,"by", cutoff_2000 = 20)
marvel$FECHA.APARICION <- as.Date(marvel$FECHA.APARICION)

#CORRECCION DE ERRORES DEL PARSEO DE FECHA
which(is.na(marvel$FECHA.APARICION))

#ELIMINACION DE COLUMNA DE FECHA ORIGINAL SIN PARSEAR
marvel[ ,c('FIRST.APPEARANCE')] <- list(NULL)


#AGREGA COLUMNA CON LOS AñOS DESDE LA APARICION DEL PERSONAJE
marvel$TIEMPO.APARICION<-floor(age_calc(marvel$FECHA.APARICION, enddate = Sys.Date(), units = "years", precise = TRUE))

#AGREGA COLUMNA CON EL PARSEO MES DE APARICION
marvel$MES.APARICION <- ymd(marvel$FECHA.APARICION) %>% 
   lubridate::month(label = TRUE, abbr = FALSE)

#AGREGA COLUMNA CON EL PARSEO TRIMESTRE DE APARICION
marvel$TRIMESTRE.APARICION<- ymd(marvel$FECHA.APARICION) %>%
   lubridate::quarter()  # Grab quarter.

#AGREGA COLUMNA CON LA DECADA DE APARICION
marvel$DECADA.APARICION <- floor_decade(marvel$YEAR)



view(marvel)

#################################################################
################FIN CREACION DE VARIABLES########################
#################################################################

#################################################################
#############INICIO CORRELACION DE VARIABLES#####################
#################################################################


marvelcorrelation<-marvel
marvelcorrelation[ ,c('name', 'urlslug')] <- list(NULL)
summary(marvelcorrelation)

marvelcorrelation$ID<-as.numeric(marvelcorrelation$ID)
marvelcorrelation$ALIGN<-as.numeric(marvelcorrelation$ALIG)
marvelcorrelation$SEX<-as.numeric(marvelcorrelation$SEX)
marvelcorrelation$GSM<-as.numeric(marvelcorrelation$GSM)
marvelcorrelation$HAIR<-as.numeric(marvelcorrelation$HAIR)
marvelcorrelation$EYE<-as.numeric(marvelcorrelation$EYE)
marvelcorrelation$ALIVE<-as.numeric(marvelcorrelation$ALIVE)
marvelcorrelation$FECHA.APARICION<-as.numeric((marvelcorrelation$FECHA.APARICION))
marvelcorrelation$YEAR<-as.numeric(marvelcorrelation$YEAR)
marvelcorrelation$MES.APARICION<-as.numeric(marvelcorrelation$MES.APARICION)
marvelcorrelation$TRIMESTRE.APARICION<-as.numeric(marvelcorrelation$TRIMESTRE.APARICION)

cor(marvelcorrelation)

#################################################################
################FIN CORRELACION DE VARIABLES#####################
#################################################################




```

## Join de Marvel y DC Comics

Creacion de un dataset con los personajes de ambas marcas, y la respectiva homogenizacion de las categorias.

```{r allcomics}

#################################################################
################INICIO DE JOIN DE DATASETS ######################
#################################################################

#CREACION DE VARIABLE DE MARCA POR CADA COMIC
dc$BRAND <-'DC'
marvel$BRAND<-'MARVEL'

#JOIN DE DATAFRAMES MARVEL Y DC
allcomics<-rbind(dc,marvel)

which(is.na(dc))
which(is.na(marvel))
which(is.na(allcomics))


#ALEATORIEDAD DE OBSERVACIONES
allcomics <- allcomics[sample(nrow(allcomics)),]


str(allcomics)
summary(allcomics)
summary(dc)
summary(marvel)

#allcomics[ ,c('FECHA.APARICION')] <- list(NULL)

#################################################################
###################FIN DE JOIN DE DATASETS ######################
#################################################################


#################################################################
#########INICIO DE HOMOGENIZACION DE FACTORES ###################
#################################################################

allcomics$BRAND<-factor(allcomics$BRAND)
levels(allcomics$BRAND)
levels(allcomics$ID)
levels(allcomics$ALIGN)
levels(allcomics$EYE)
levels(allcomics$HAIR)
levels(allcomics$GSM)
allcomics$GSM <- as.character(allcomics$GSM) #ELIMINACION DE FACTOR PARA PODER EDITAR LOS VALORES DE LA COLUMNA
allcomics$GSM[allcomics$GSM=='Transvestites'] <- 'Transvestites Characters' 
allcomics$GSM <- factor (allcomics$GSM) #RECONVERSION A FACTOR

which(is.na(allcomics))


#################################################################
############FIN DE HOMOGENIZACION DE FACTORES ###################
#################################################################


#################################################################
#############INICIO CORRELACION DE VARIABLES#####################
#################################################################


allcomicscorrelation<-allcomics
#allcomicscorrelation[ ,c('urlslug')] <- list(NULL)

summary(allcomicscorrelation)

str(allcomicscorrelation)
allcomicscorrelation$MES.APARICION <- as.numeric(allcomicscorrelation$MES.APARICION)
allcomicscorrelation$MES.APARICION <- as.numeric(allcomicscorrelation$MES.APARICION)


allcomicscorrelation$name<-factor(allcomicscorrelation$name)
allcomicscorrelation$urlslug<-factor(allcomicscorrelation$urlslug)
allcomicscorrelation$BRAND<-factor(allcomicscorrelation$BRAND)
allcomicscorrelation$YEAR <- factor(allcomicscorrelation$YEAR)

allcomicscorrelation$TRIMESTRE.APARICION <- factor(allcomicscorrelation$TRIMESTRE.APARICION)
allcomicscorrelation$DECADA.APARICION <- factor(allcomicscorrelation$DECADA.APARICION)

allcomicscorrelation$name<-as.numeric(allcomicscorrelation$name)
allcomicscorrelation$urlslug<-as.numeric(allcomicscorrelation$urlslug)
allcomicscorrelation$ID<-as.numeric(allcomicscorrelation$ID)
allcomicscorrelation$ALIGN<-as.numeric(allcomicscorrelation$ALIG)
allcomicscorrelation$SEX<-as.numeric(allcomicscorrelation$SEX)
allcomicscorrelation$EYE<-as.numeric(allcomicscorrelation$EYE)
allcomicscorrelation$HAIR<-as.numeric(allcomicscorrelation$HAIR)
allcomicscorrelation$GSM<-as.numeric(allcomicscorrelation$GSM)
allcomicscorrelation$ALIVE<-as.numeric(allcomicscorrelation$ALIVE)
allcomicscorrelation$FECHA.APARICION<-as.numeric(allcomicscorrelation$FECHA.APARICION)
allcomicscorrelation$YEAR<-as.numeric(allcomicscorrelation$YEAR)
allcomicscorrelation$MES.APARICION<-as.numeric(allcomicscorrelation$MES.APARICION)
allcomicscorrelation$TRIMESTRE.APARICION<-as.numeric(allcomicscorrelation$TRIMESTRE.APARICION)
allcomicscorrelation$DECADA.APARICION<-as.numeric(allcomicscorrelation$DECADA.APARICION)
allcomicscorrelation$BRAND<-as.numeric(allcomicscorrelation$BRAND)
str(allcomicscorrelation)
view(allcomicscorrelation)

cor(allcomicscorrelation)
which(is.na(allcomics))

#################################################################
################FIN CORRELACION DE VARIABLES#####################
#################################################################

```


## Analisis Exploratorio

Creacion de un dataset con los personajes de ambas marcas, y la respectiva homogenizacion de las categorias.

```{r histogramas}

#GSMCOUNTS <- allcomics %>%
#  group_by(GSM) %>%
#  summarise(counts = n())
#GSMCOUNTS

#https://rpubs.com/cardiomoon/329677
#http://www.sthda.com/english/articles/32-r-graphics-essentials/132-plot-grouped-data-box-plot-bar-plot-and-more/


topcomics<-allcomics %>%
   arrange(desc(APPEARANCES)) %>%
   head(10)

oldestcomics<-allcomics %>%
   arrange(YEAR) %>%
   head(10)

view(allcomics)

ggplot(topcomics, aes(x=reorder(name, -APPEARANCES), y=APPEARANCES,fill=BRAND,label=APPEARANCES)) + 
  geom_bar(stat = "identity") +
   theme_classic() +
   theme(legend.position = 'right')+
  theme(axis.text.x=element_text(angle = -45, hjust = 0))+
    geom_text(size = 3, position = position_stack(vjust = 0.5))+
     labs(title = 'Los 10 Personajes con Mayores Apariciones divididos por Marca') 

 ggplot(oldestcomics, aes(x=reorder(name, FECHA.APARICION), y=factor(YEAR),fill=BRAND,label=FECHA.APARICION)) + 
  geom_bar(stat = "identity") +
   theme_classic() +
   theme(legend.position = 'right')+
  theme(axis.text.x=element_text(angle = -45, hjust = 0))+
     geom_text(size = 3, angle = 45, position = position_stack(vjust = 0.5))+
     labs(title = 'Los 10 Personajes con más antiguos divididos por Marca') 

par(mfrow=c(2,2))
interaction.plot(allcomics$BRAND,allcomics$SEX,allcomics$APPEARANCES, main ="Apariciones Segun Sexo vs Marca")
interaction.plot(allcomics$BRAND,allcomics$ALIGN,allcomics$APPEARANCES, main ="Apariciones Segun Bando vs Marca")
interaction.plot(allcomics$BRAND,allcomics$ALIVE,allcomics$APPEARANCES, main ="Apariciones Segun Estado vs Marca")
interaction.plot(allcomics$BRAND,allcomics$ID,allcomics$APPEARANCES, main ="Apariciones Segun Identidad vs Marca")


ggplot(allcomics,aes(x=factor(GSM),fill=factor(BRAND)))+
    geom_bar(position="dodge")+
    geom_text(aes(label=..count..),stat='count',position = position_stack(vjust = .5))+
  coord_flip()+
   labs(title = 'COMPOSICION DEL DATASET: MARCA VS GENERO') +
    facet_grid(~BRAND)

ggplot(allcomics,aes(x=factor(SEX),fill=factor(BRAND)))+
    geom_bar(position="dodge")+
    geom_text(aes(label=scales::percent(..count../sum(..count..))),stat='count',position=position_dodge(0.9),vjust=-0.2)+
   labs(title = 'COMPOSICION DEL DATASET: SEGUN EL SEXO') 


ggplot(allcomics,aes(x=factor(SEX),fill=factor(DECADA.APARICION)))+
    geom_bar(position="dodge")+
    geom_text(aes(label=..count..),stat='count',position=position_dodge(0.9),vjust=-0.2)+
   labs(title = 'EVOLUCION DEL SEXO DE PERSONAJES A TRAVES DEL TIEMPO') +
    facet_grid(~BRAND) 

ggplot(allcomics,aes(x=(FECHA.APARICION),group=SEX,shape=SEX,color=SEX))+
geom_line(stat = "count")+
   labs(title = 'EVOLUCION DE LA APARICION DE PERSONAJES SEGUN SEXO') +
    facet_grid(~BRAND) 


ggplot(allcomics,aes(x=factor(DECADA.APARICION),fill=factor(ALIGN)))+
    geom_bar(position="dodge")+
    geom_text(aes(label=..count..),stat='count',position=position_dodge(0.9),vjust=-0.2)+
   labs(title = 'CANTIDAD DE PERSONAJES SEGUN BANDOS POR DECADAS') 

ggplot(allcomics,aes(x=factor(DECADA.APARICION),group=ALIGN,shape=ALIGN,color=ALIGN))+
geom_line(stat = "count")+
   labs(title = 'CANTIDAD DE PERSONAJES SEGUN BANDOS POR DECADAS') +
    theme(axis.text.x=element_text(angle = -45, hjust = 0))+
    facet_grid(~BRAND) 

ggplot(allcomics,aes(x=factor(BRAND),fill=factor(ALIGN)))+
    geom_bar(position="dodge")+
    geom_text(aes(label=..count..),stat='count',position=position_dodge(0.9),vjust=-0.2)+
   labs(title = 'EVOLUCION DEL BANDO DE LOS PERSONAJES SEGUN LA MARCA DEL COMIC') +
    facet_grid(~SEX)

ggplot(allcomics)+
  aes(x=FECHA.APARICION,y=APPEARANCES, colour=BRAND)+
  geom_point()+
  geom_smooth(method = 'lm', color = 'red3', fill = 'red3')+   
  labs(title = 'CANTIDAD DE APARICIONES DEL PERSONAJES SEGUN SU CREACION')

ggplot(allcomics)+
  aes(x=YEAR,y=APPEARANCES, colour=SEX)+
  geom_point()+
  facet_grid(~BRAND)+
  geom_smooth(method = 'lm', color = 'red3', fill = 'red3')

ggplot(allcomics)+
  aes(x=APPEARANCES,y=EYE)+
  geom_point()

ggplot(allcomics)+
  aes(x=HAIR,y=EYE)+
  geom_point()

ggplot(allcomics)+
  aes(x=APPEARANCES,y=HAIR)+
  geom_point()

ggplot(allcomics)+
  aes(x=YEAR,y=APPEARANCES)+
  geom_point()+
    geom_smooth(method = 'lm', color = 'red3', fill = 'red3')

ggplot(allcomics)+
  aes(x=TIEMPO.APARICION,y=APPEARANCES,colour=SEX)+
  geom_point()+
    facet_grid(~BRAND)+
  geom_smooth(method = 'lm', color = 'red3', fill = 'red3')


# PROMEDIO DE APARICIONES SEGUN GENERO
ggplot(allcomics,  aes(x = fct_infreq(GSM),  y=APPEARANCES, fill = GSM)) + 
   stat_summary_bin(fun.y = mean, geom = "bar") + 
 #  scale_fill_grey() + 
   coord_flip() +
   theme_classic() +
   theme(legend.position = 'top') +    
   labs(title = 'Promedio de Apariciones Segun el Genero') 

# PROMEDIO DE APARICIONES SEGUN SEXO
ggplot(allcomics,  aes(x = fct_infreq(SEX),  y=APPEARANCES, fill = SEX)) + 
   stat_summary_bin(fun.y = mean, geom = "bar") + 
 #  scale_fill_grey() + 
   coord_flip() +
   theme_classic() +
   theme(legend.position = 'top') +  
   labs(title = 'Promedio de Apariciones Segun el Sexo')+
    facet_grid(~BRAND)


# PROMEDIO DE APARICIONES SEGUN SEXO
ggplot(allcomics,  aes(x = DECADA.APARICION,  y=APPEARANCES, fill = SEX)) + 
   stat_summary_bin(fun.y = mean, geom = "bar") + 
 #  scale_fill_grey() + 
   theme_classic() +
   theme(legend.position = 'top') +  
   labs(title = 'Promedio de Aparicion segun la decada de Aparicion y el sexo del personaje')+
    facet_grid(~BRAND)

# PROMEDIO DE APARICIONES SEGUN HAIR
ggplot(allcomics,  aes(x = fct_infreq(EYE),  y=APPEARANCES, fill = HAIR)) + 
   stat_summary_bin(fun.y = mean, geom = "bar") + 
 #  scale_fill_grey() + 
   coord_flip() +
   theme_classic() +
   theme(legend.position = 'right') +  
   labs(title = 'Promedio de Apariciones Segun caracteristicas fisicas') +
    facet_grid(~BRAND)


which(is.na(allcomics))

str(allcomics)
#allcomics[ ,c('name','urlslug','TIEMPO.APARICION','YEAR','MES.APARICION','ID','DECADA.APARICION','TRIMESTRE.APARICION','ALIVE','BRAND','GSM','SEX')] <- list(NULL)
allcomics[ ,c('name','urlslug')] <- list(NULL)
allcomics$FECHA.APARICION<-factor(allcomics$FECHA.APARICION)
allcomics$FECHA.APARICION<-as.numeric(allcomics$FECHA.APARICION)
allcomics$BRAND<-factor(allcomics$BRAND)

set.seed(123)   #  set seed to ensure you always have same random numbers generated
sample = sample.split(allcomics,SplitRatio = 0.8) # splits the data in the ratio mentioned in SplitRatio. After splitting marks these rows as logical TRUE and the the remaining are marked as logical FALSE
train =subset(allcomics,sample ==TRUE) # creates a training dataset named train1 with rows which are marked as TRUE
test=subset(allcomics, sample==FALSE)

str(train)
str(test)

summary(train)

test[ ,c('APPEARANCES')] <- list(NULL)

which(is.na(allcomics))
which(is.na(train))

aggr(train, sortVars = TRUE, prop = FALSE, cex.axis = .35, 
     numbers = TRUE, col = c('grey99','red'))

aggr(test, sortVars = TRUE, prop = FALSE, cex.axis = .35, 
     numbers = TRUE, col = c('grey99','red'))

set.seed(222)
rf_model <- randomForest(APPEARANCES ~ .,
                         data = train, 
                         ntree = 501,
                         replace = TRUE,
                         nodesize = 9,
                         importance = TRUE); print(rf_model)




# Create an object for importance of variables
importance <- importance(rf_model) 

# Create data frame using importance. 
varImportance <- data.frame(Variables = row.names(importance), 
                            Importance = round(importance[,'IncNodePurity'], 0))

rf_model
# Create interactive plot.
ggplotly(ggplot(varImportance, aes(x = reorder(Variables, Importance), 
                           y = Importance, fill = Importance)) +
       geom_bar(stat='identity') + 
       labs(title = 'Importancia del predictor', x = 'Predictor', y = 'RMSLE') +
       coord_flip() + 
       theme_light())

correlation <-cor(allcomicscorrelation)

corrplot(correlation,method="circle")


```

# Predicción

Ahora que hemos creado nuestro modelo, lo usaremos para clasificar la marca del comic

Ejecución de la predicción con los datos de prueba TEST:
```{r}
prediction <- predict(rf_model, test)
solution <- data.frame(id = test$page_id, BRAND = prediction)
write.csv(solution, file = 'clasificacion_marca.csv', row.names = F)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
